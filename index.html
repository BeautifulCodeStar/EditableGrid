<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>EditableGrid</title>
		
		<script src="lib/editablegrid.js"></script>
		<script src="lib/editablegrid_renderers.js" ></script>
		<script src="lib/editablegrid_editors.js" ></script>
		<script src="lib/editablegrid_validators.js" ></script>
		<script src="lib/editablegrid_utils.js" ></script>
		<script src="lib/editablegrid_charts.js" ></script>
		<script src="jquery/jquery-1.6.4.min.js" ></script>
		<script src="jquery/jquery-ui-1.8.16.custom.min.js" ></script>

		<link href="http://fonts.googleapis.com/css?family=Ubuntu:300,400,700" rel="stylesheet" type="text/css">
		<link href="css/editablegrid.css" rel="stylesheet" type="text/css">
		<link href="css/normalize.css" rel="stylesheet" type="text/css">
		<!-- <link href="css/responsive.css" rel="stylesheet" type="text/css"> -->
		<!-- <link href="css/style.css" rel="stylesheet" type="text/css"> -->
		<link href="css/font-awesome.css" rel="stylesheet" type="text/css">
		<link rel="stylesheet" href="style.css" type="text/css" media="screen">
		
		<style>
			body { font-family:'lucida grande', tahoma, verdana, arial, sans-serif; font-size:11px; }
			h1 { font-size: 15px; }
			a { color: black; text-decoration: none; font-weight: 100}
			a:hover { text-decoration: underline; }
			#plc {
				display: grid;
				/*justify-content: center;*/
			}
			.editablegrid-subgroup_id, .editablegrid-_id {
				display: none;
			}
			th { text-align: center; padding:5px 10px;}
			table { border-radius: 10px;}
			table.plc, table.math { border-collapse: collapse; border: 1px solid #CCB; width: auto; font-size: 15px;}
			table.plc td, table.math td{ padding: 5px;  font-size: 15px; border: 1px solid #403b3b29; width:50px; height: 28px;}
			table.plc th, table.math th { background: gainsboro; text-align: left; font-size: 16px; height: 40px; color:black !important; }
			td:nth-child(even){background: #eeeeee}
			td:nth-child(odd) {background: #FFF}
			input.invalid { background: red; color: #FDFDFD; }
			/*tabletr:hover {background: #FFF !important; }	*/
			table.plc tr:hover { background: black !important;}
			td:visited { background: red;}
		</style>
		
		<script>
			var editableGrid;
			var mathGrid;
			window.onload = function() {
				var result = getJSON("https://api.autobits.in/api/subgroups/2/tags-new").then(res => {
					var plc = [];
					var data = [];
					res.forEach((item, index) => {
						if (index === 0) {
							plc.push({ name: '_id', label: 'TagId', datatype: "string", editable: false })
							plc.push({ name: 'subgroup_id', label: 'Subgroup Id', datatype: "string", editable: false })
							plc.push({ name: 'subgroup_name', label: 'Subgroup name', datatype: "string", editable: false })
							plc.push({ name: 'subgroup_type', label: 'Subgroup type', datatype: "string", editable: true })
							plc.push({ name: 'name', label: 'Name', datatype: "string", editable: true })
							plc.push({ name: 'address', label: 'Address', datatype: "string", editable: false })
							plc.push({ name: 'data_type', label: 'Data type', datatype: "string", editable: true })
							plc.push({ name: 'base_unit', label: 'Base unit', datatype: "string", editable: true })
							plc.push({ name: 'interval', label: 'Interval', datatype: "string", editable: true })
							plc.push({ name: 'writable', label: 'Writable', datatype: "string", editable: true })
							plc.push({ name: 'fixed_float', label: 'Fixed_float', datatype: "string", editable: true })
							plc.push({ name: 'reset', label: 'Reset', datatype: "string", editable: true })
							plc.push({ name: 'offset_type', label: 'Offset_type', datatype: "string", editable: true })
							plc.push({ name: 'offset_method', label: 'Offset_method', datatype: "string", editable: true })
							plc.push({ name: 'offset_value', label: 'Offset_value', datatype: "integer", editable: true })
							plc.push({ name: 'offset_tag', label: 'Offset_tag', datatype: "string", editable: true })
							plc.push({ name: 'reduce_type', label: 'Reduce_type', datatype: "string", editable: true })
							plc.push({ name: 'reduce_data', label: 'Reduce_data', datatype: "string", editable: true })
						}
						data.push({
							No: index + 1,
							values:	{
								_id: item._id, // 0
								subgroup_id: item.subgroup_id,
								subgroup_name: item.subgroup_name,
								subgroup_type: item.subgroup_type,
								name: item.name, // 1
								address: item.address, // 2
								data_type: item.data_type, // 4
								base_unit: item.base_unit, // 3
								interval: item.interval, // 3
								writable: item.writable, //14
								fixed_float: item.fixed_float, //5
								reset: item.reset, // 12
								offset_type: item.offset_type, // 8
								offset_method: item.offset_method, //6
								offset_value: item.offset_value, // 9 
								offset_tag: item.offset_tag, //7
								reduce_type: item.reduce_type, // 11
								reduce_data: item.reduce_data, // 10
							}	
						})
					})
					plc[6].values = {};
					plc[7].values = {};
					plc[8].values = {};
					plc[9].values = {};
					plc[10].values = {};
					plc[11].values = {};
					plc[12].values = {};
					plc[13].values = {};	
					// plc[14].values = {};
					plc[15].values = {};
					plc[16].values = {};

					plc[6].values["data_type"] = {"true":"true", "false":"false", "modbus": "modbus", "analog":"analog"};
					plc[7].values["base_unit"] = {"kg": "kg", "": "none", "litre":"litre"};
					plc[8].values["inetrval"] = {"250": "250ms", "500": "500ms", "750": "750ms", "1":"1 Second", "30":"30 Seconds", "60":"1 minute"};
					plc[9].values["writable"] = {"true": "TRUE", "false": "FALSE"};
					plc[10].values["fixed_float"] = {"":"0","1":"1","2": "2","3": "3","4": "4"};
					plc[11].values["reset"] = {"true": "TRUE", "false": "FALSE"};
					plc[12].values["offset_type"] = {"none": "None", "static":"Static", "tag": "By Tag"};
					plc[13].values["offset_method"] = {"": "None","divide": "Divide", "multiply": "Multiply", "add": "Add", "subract": "Subract"};
					// plc[14].values["offset_value"] = {"": "Enable"};
					var offsetTag = {};
					res.forEach(item=> {
						var key = item.name.replace(/\s/g, '');
						// plc[15].values["offset_tag"][key] = item.name;
						offsetTag[key] = item.name
					})
					console.log(offsetTag)
					plc[15].values["offset_tag"] = offsetTag;
					plc[16].values["reduce_type"] = {"absoulte": "Absolute", "fixed": "Fixed", "percent": "Percent", "static":"Static",  "": "None"};

					editableGrid = new EditableGrid("first_table", {
						enableSort: true, // true is the default, set it to false if you don't want sorting to be enabled
						editmode: "absolute", // change this to "fixed" to test out editorzone, and to "static" to get the old-school mode
						editorzoneid: "edition", // will be used only if editmode is set to "fixed"
						pageSize: 10,
						maxBars: 10,
					});

					editableGrid.load({"metadata": plc, "data": data});
					editableGrid.renderGrid("plc", "plc");
					editableGrid.updatePaginator();
					editableGrid.modelChanged = function(rowIndex, columnIndex, oldValue, newValue, row) {
						return true;
					}
					editableGrid.editCell = function(rowIndex, columnIndex) {
						var row = editableGrid.getRow(rowIndex);
						// #e7d12d78
						var ids = [
							"_id", "subgroup_id", "subgroup_name", "subgroup_type", "name", "address", "data_type", "base_unit", "interval", "writable", 'fixed_float', "offset_method", "offset_tag", "offset_tag", "offset_type", "offset_value","reduce_data", "reduce_type", "reset"];
						rowInd = rowIndex + 1;
						var cell = editableGrid.getCell(rowIndex, 0)
						var tagId = editableGrid.data[rowIndex].columns[0]
						// tagId = 175 //175
						const url = "https://api.autobits.in/api/tags/" + tagId + "/maths-new";
						const getSecond = getJSON(url).then(res => {
							var plc = [];
							var data = [];
							if (!res) {
								return;
							}
							const item = res;
								plc.push({ name: 'status', label: 'Status', datatype: "string", editable: true })
								plc.push({ name: 'status_name_0', label: 'Status_name_0', datatype: "string", editable: true })
								plc.push({ name: 'status_name_1', label: 'Status_name_1', datatype: "string", editable: true })
								plc.push({ name: 'cycle', label: 'cycle', Datatype: "string", editable: false })
								plc.push({ name: 'cycle_ranges', label: 'Cycle_ranges', datatype: "string", editable: true })
								plc.push({ name: 'counter_enabler', label: 'Counter_enabler', datatype: "string", editable: true })
								plc.push({ name: 'counter', label: 'Counter', datatype: "string" })
								plc.push({ name: 'cycle_name_0_1', label: 'Cycle_name_0_1', datatype: "string", editable: true })
								plc.push({ name: 'cycle_name_1_0', label: 'Cycle_name_1_0', datatype: "string", editable: true })
								plc.push({ name: 'runtime_enabler', label: 'Runtime_enabler', datatype: "string", editable: true })
								plc.push({ name: 'runtime', label: 'runtime', datatype: "string", editable: true })
								plc.push({ name: 'rate', label: 'Rate', datatype: "string", editable: true })
								plc.push({ name: 'rate_delived_unit', label: 'Rate_delived_unit', datatype: "string", editable: true })
								plc.push({ name: 'rate_constant', label: 'Rate_constant', datatype: "string", editable: true })
								plc.push({ name: 'mapping', label: 'Mapping', datatype: "string", editable: true })
								plc.push({ name: 'mapping_reference', label: 'Mapping_reference', datatype: "string", editable: true })

								data.push({
									No: 0,
									values:	{
										status: item.status, // 0
										status_name_0: item.status__name_0, // 1
										status_name_1: item.status__name_1,
										cycle: item.cycle,
										cycle_ranges: item.cycle_ranges,
										counter_enabler: item.counter__enabler?item.counter__enabler.toString() : item.counter__enabler, // 4
										counter: item.counter, // 3
										cycle_name_0_1: item.cycle__name_0_1,
										cycle_name_1_0: item.cycle__name_1_0, // 2
										runtime_enabler: item.runtime__enabler? item.runtime__enabler.toString(): item.runtime__enabler, //5
										runtime: item.runtime, //6
										rate: item.rate, //7
										rate_delived_unit: item.rate__delived_unit? item.rate__delived_unit.toString() : item.rate__delived_unit, // 8
										rate_constant: item.rate__constant? item.rate__constant.toString() : item.rate__constant, // 9 
										mapping: item.mapping, // 10
										mapping_reference: item.mapping_reference, // 11
									}	
								})
								document.querySelector('#status').value = item.status;
								document.querySelector('#status_name_0').value = item.status__name_0;
								document.querySelector('#status_name_1').value = item.status__name_1;
								document.querySelector('#cycle').value = item.cycle;
								document.querySelector('#cycle_ranges').value = item.cycle__ranges;
								document.querySelector('#counter_enabler').value = item.counter__enabler;
								document.querySelector('#counter').value = item.counter;
								document.querySelector('#cycle_name_0_1').value = item.cycle__name_0_1;
								document.querySelector('#cycle_name_1_0').value = item.cycle__name_1_0;
								document.querySelector('#runtime_enabler').value = item.runtime__enabler;
								document.querySelector('#runtime').value = item.runtime;
								document.querySelector('#rate').value = item.rate;
								document.querySelector('#rate_derived_unit').value = item.rate__derived_unit;
								document.querySelector('#mapping').value = item.mapping;
								document.querySelector('#mapping_reference').value = item.mapping_reference;

								plc[5].values = {};
								plc[9].values = {};
								plc[12].values = {};
								plc[13].values = {};	

								plc[5].values["counter_enabler"] = {"1": "TRUE", "0": "FALSE"};
								plc[9].values["runtime_enabler"] = {"1": "TRUE", "0": "FALSE"};
								plc[12].values["rate_delived_unit"] = {"1": "TRUE", "0": "FALSE"};
								plc[13].values["rate_constant"] = {"1": "TRUE", "0": "FALSE"};
							})
							if (columnIndex === 13 || columnIndex === 14 || columnIndex === 15) {
								var offsetType = editableGrid.data[rowIndex].columns[12];
								if (offsetType === "none") {
									return true;
								} else if (offsetType === "static" && columnIndex === 15) {
									return true;
								} else if (offsetType === "tag" && columnIndex === 14) {
									return true;
								}
							}
							if (columnIndex === 17) {
								var reduceType = editableGrid.data[rowIndex].columns[16];
								if (reduceType !== "static" && reduceType !== "percent") {
									return true;
								}
							}
							var target = this.getCell(rowIndex, columnIndex);
							with (this) {

								var column = columns[columnIndex];
								if (column) {

									// if another row has been selected: callback
									if (rowIndex > -1) {
										rowSelected(lastSelectedRowIndex, rowIndex);				
										lastSelectedRowIndex = rowIndex;
									}

									// edit current cell value
									if (!column.editable) { readonlyWarning(column); }
									else {
										if (rowIndex < 0) { 
											if (column.headerEditor && isHeaderEditable(rowIndex, columnIndex))
												column.headerEditor.edit(rowIndex, columnIndex, target, column.label);
										}
										else if (column.cellEditor && isEditable(rowIndex, columnIndex))
											column.cellEditor.edit(rowIndex, columnIndex, target, getValueAt(rowIndex, columnIndex));
									}
								}
									
							}
						}
				});
			}

			var kk = {}
			

			const filter = () => {
				const filterStr = document.querySelector('#filter').value;
				editableGrid.filter(filterStr, undefined);
			}
		

			const getJSON = url => {
				return new Promise((resolve, reject) => {
					var ajaxRequest = new XMLHttpRequest();
					ajaxRequest.onreadystatechange = function () {
						if (this.readyState == 4 && this.status == 200) {
							resolve(JSON.parse(this.responseText));
						} 
					};

					ajaxRequest.open("GET", url, true);
					ajaxRequest.send("");
				})
			}
		
			EditableGrid.prototype.initializeGrid = function() 
			{
				with (this) {
					$("#pagesize").val(pageSize).change(function() { editableGrid.setPageSize($("#pagesize").val()); });
				}
			};

			EditableGrid.prototype.updatePaginator = function()
			{
				var paginator = $("#paginator").empty();
				var nbPages = this.getPageCount();

				// get interval
				var interval = this.getSlidingPageInterval(20);
				// var interval = 20;
				if (interval == null) return;
				
				//get pages in interval (with links except for the current page)
				var pages = this.getPagesInInterval(interval, function(pageIndex, isCurrent) {
					if (isCurrent) return "" + (pageIndex + 1);
					return $("<a>").css("cursor", "pointer").html(pageIndex + 1).click(function(event) { editableGrid.setPageIndex(parseInt($(this).html()) - 1); });
				});
					
				// "first" link
				var link = $("<a>").html("<i class='fa fa-fast-backward'></i>");
				if (!this.canGoBack()) link.css({ opacity : 0.4, filter: "alpha(opacity=40)" });
				else link.css("cursor", "pointer").click(function(event) { editableGrid.firstPage(); });
				paginator.append(link);

				// "prev" link
				link = $("<a>").html("<i class='fa fa-backward'></i>");
				if (!this.canGoBack()) link.css({ opacity : 0.4, filter: "alpha(opacity=40)" });
				else link.css("cursor", "pointer").click(function(event) { editableGrid.prevPage(); });
				paginator.append(link);

				// pages
				for (p = 0; p < pages.length; p++) paginator.append(pages[p]).append(" | ");
				
				// "next" link
				link = $("<a>").html("<i class='fa fa-forward'></i>");
				if (!this.canGoForward()) link.css({ opacity : 0.4, filter: "alpha(opacity=40)" });
				else link.css("cursor", "pointer").click(function(event) { editableGrid.nextPage(); });
				paginator.append(link);

				// "last" link
				link = $("<a>").html("<i class='fa fa-fast-forward'></i>");
				if (!this.canGoForward()) link.css({ opacity : 0.4, filter: "alpha(opacity=40)" });
				else link.css("cursor", "pointer").click(function(event) { editableGrid.lastPage(); });
				paginator.append(link);
			};
		</script>
		
	</head>
	
	<body>
	<div id="pagecontrol">
		<!-- <label for="pagecontrol">Rows per page: </label>
		<select id="pagesize" name="pagesize">
			<option value="5">5</option>
			<option value="10">10</option>
			<option value="15">15</option>
			<option value="20">20</option>
			<option value="25">25</option>
			<option value="30">30</option>
			<option value="40">40</option>
			<option value="50">50</option>
		</select> -->

		<!-- Grid filter -->
		<label for="filter">Filter :</label>
		<input type="text" id="filter" onkeyup="filter()">
	</div>
		<div id="plc"></div>
		<div id="paginator" onclick="editableGrid.updatePaginator()"></div>
		<!-- <div id="math" align="center" style="margin-top: 20px;"></div> -->
		<div id="math">
			<div class="math-title">
				<h1>Maths</h1>
			</div>
			<div id="math-info">
				<div class="form-input">
					<label class="math-label" for="status">Status</label>
					<input type="text" class="input-tag" id="status">
				</div>
				<div class="form-input">
					<label class="math-label" for="status_name_0">Status_name_0</label>
					<input type="text" class="input-tag" id="status_name_0">
				</div>
				<div class="form-input">
					<label class="math-label" for="status_name_1">Status_name_1</label>
					<input type="text" class="input-tag" id="status_name_1">
				</div>
			</div>

			<div id="math-info" style="display:block">
				<div class="form-input">
					<label class="math-label" for="cycle">Cycle</label>
					<input type="text" class="input-tag" id="cycle">
				</div>
				<div class="form-input">
					<label class="math-label" for="cycle_ranges">Cycle_ranges</label>
					<input type="text" class="input-tag" id="cycle_ranges">
				</div>
				<div class="form-input">
					<label class="math-label" for="cycle_name_0_1">Cycle_name_0_1</label>
					<input type="text" class="input-tag" id="cycle_name_0_1">
				</div>
				<div class="form-input">
					<label class="math-label" for="cycle_name_1_0">Cycle_name_1_0</label>
					<input type="text" class="input-tag" id="cycle_name_1_0">
				</div>	
			</div>

			<div id="third-block" style="display:block">
				<div class="form-input">
					<label class="math-label" for="counter_enabler">Counter__enabler</label>
					<input type="text" class="input-tag" id="counter_enabler">
				</div>
				<div class="form-input">
					<label class="math-label" for="counter">Counter</label>
					<input type="text" class="input-tag" id="counter">
				</div>
				<div class="form-input">
					<label class="math-label" for="rate">Rate</label>
					<input type="text" class="input-tag" id="rate">
				</div>
				<div class="form-input">
					<label class="math-label" for="rate_derived_unit">Rate__derived_unit</label>
					<input type="text" class="input-tag" id="rate_derived_unit">
				</div>	
				<div class="form-input">
					<label class="math-label" for="rate__constant">Rate__constant</label>
					<input type="text" class="input-tag" id="rate_constant">
				</div>	
			</div>

			<div id="forth-block" style="display:block">
				<div class="form-input">
					<label class="math-label" for="mapping">Mapping</label>
					<input type="text" class="input-tag" id="mapping">
				</div>
				<div class="form-input">
					<label class="math-label" for="mapping_reference">Mapping_reference</label>
					<input type="text" class="input-tag" id="mapping_reference">
				</div>
				<div class="form-input">
					<label class="math-label" for="runtime__enabler">Runtime__enabler</label>
					<input type="text" class="input-tag" id="runtime_enabler">
				</div>
				<div class="form-input">
					<label class="math-label" for="runtime">Runtime</label>
					<input type="text" class="input-tag" id="runtime">
				</div>	
			</div>
		</div>

	</body>

</html>
